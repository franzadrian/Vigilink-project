{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}My Community - VigiLink{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- Critical CSS inline for faster rendering -->
<style>
/* Critical styles for above-the-fold content */
:root {
    --primary: #3b82f6;
    --dark: #1f2937;
    --transition: all 0.3s ease;
    --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
}

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
.co-hero { text-align: center; margin-bottom: 30px; }
.co-hero h1 { font-size: 2.5rem; margin-bottom: 10px; color: var(--dark); }
.stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 15px; }
.nav-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
.nav-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: var(--card-shadow); cursor: pointer; transition: var(--transition); }
.nav-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
</style>
<!-- Non-critical CSS loaded asynchronously -->
<link rel="preload" href="{% static 'communityowner/css/communityowner_styles.css' %}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{% static 'communityowner/css/communityowner_styles.css' %}"></noscript>
{% endblock %}

{% block content %}
    <div class="container">
        <header class="co-hero">
            <div class="co-logo">
                <div class="co-logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
            <h1>My Community</h1>
            <p class="subtitle">Complete overview of users, reports, and analytics</p>
        </header>
        
        <!-- Stats Section -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-users">0</h3>
                    <p>Total Users</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon reports">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-reports">{{ reports_stats.total_reports|default:0 }}</h3>
                    <p>Total Reports</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon month">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-info">
                    <h3 id="month-reports">{{ reports_stats.month_reports|default:0 }}</h3>
                    <p>Last Month Reports</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon events">
                    <i class="fas fa-calendar-plus"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-events">0</h3>
                    <p>Total Events</p>
                </div>
            </div>
        </div>
        
        <div class="nav-cards">
            <div class="nav-card active" data-target="details">
                <div class="card-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="card-title">Community Details</div>
                <div class="card-desc">View and edit your community info</div>
            </div>

            <div class="nav-card" data-target="secret">
                <div class="card-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="card-title">My Community Code</div>
                <div class="card-desc">Your permanent owner code (private)</div>
            </div>
            
            <div class="nav-card" data-target="reports">
                <div class="card-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="card-title">Security Reports</div>
                <div class="card-desc">Download and analyze security incident reports</div>
            </div>
            
            <div class="nav-card{% if ec_count == 0 %} nav-card-warning{% endif %}" data-target="emergency">
                <div class="card-icon {% if ec_count == 0 %}warn-icon{% endif %}">
                    <i class="fas fa-phone"></i>
                </div>
                <div class="card-title">
                    Emergency Calls
                    {% if ec_count == 0 %}
                    <span class="warn-badge"><i class="fas fa-exclamation-triangle"></i> Missing</span>
                    {% endif %}
                </div>
                <div class="card-desc">
                    {% if ec_count == 0 %}
                    <span class="warn-text">No contacts set — click to add now</span>
                    {% else %}
                    Add and manage emergency numbers
                    {% endif %}
                </div>
            </div>
            
            <div class="nav-card" data-target="events">
                <div class="card-icon">
                    <i class="fas fa-calendar-plus"></i>
                </div>
                <div class="card-title">Event Announcements</div>
                <div class="card-desc">Create and manage community events and announcements</div>
            </div>
        </div>
        
            <div class="content-area" style="display:none;">
            <!-- Community Details Section -->
            <div id="details" class="content-section" data-loaded="true" style="display:none;">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Community Details</h2>
                        <p class="section-subtitle">Your community information</p>
                    </div>
                    <div></div>
                </div>

                <!-- Inline edit form -->
                <form id="co-details-form" method="post" class="co-details-card" novalidate>
                    {% csrf_token %}
                    <div class="co-details-grid">
                        <div class="co-field">
                            <label for="edit_community_name">Community Name</label>
                            <input type="text" id="edit_community_name" name="community_name" required value="{{ profile.community_name|default:'' }}" autocomplete="off" placeholder="e.g., Greenfield Village" />
                            <div id="edit_community_name_error" class="co-error-text" style="display:none;">This community name is already taken. Please choose another.</div>
                        </div>
                        <div class="co-field">
                            <label for="edit_community_address">Community Address</label>
                            <input type="text" id="edit_community_address" name="community_address" required value="{{ profile.community_address|default:'' }}" placeholder="e.g., 123 Palm St, Springfield" />
                        </div>
                    </div>
                    <div class="co-details-actions" id="co-inline-actions" style="display:none;">
                        <button type="submit" id="co-details-save" class="action-btn edit-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" id="co-details-cancel" class="action-btn delete-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>

            </div>

            <!-- Users Section -->
            <div id="users" class="content-section" data-loaded="false" style="display:none;">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">User Management</h2>
                        <p class="section-subtitle">Manage all user accounts and permissions</p>
                    </div>
                    <div></div>
                </div>
                <div class="user-grid" style="display:none;"></div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports" class="content-section" data-loaded="false" style="display:none;">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Reports & Analytics</h2>
                        <p class="section-subtitle">View and analyze system reports</p>
                    </div>
                </div>
                
                <div class="report-list">
                    <!-- Report cards will be dynamically generated -->
                </div>
            </div>
            
            
            
            <!-- Secret Code Section -->
            <div id="secret" class="content-section" data-loaded="true" style="display:none;">
                <div class="secret-container">
                    <div class="secret-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2 class="section-title">My Community Code</h2>
                    <p class="section-subtitle">This is your permanent owner code. Keep it private.</p>
                    <div id="code-display" class="code-display {% if profile and profile.secret_code %}revealed{% endif %}"
                         data-code="{{ profile.secret_code|default:'' }}">{{ profile.secret_code|default:'' }}</div>
                    <button id="copy-code-btn" class="reveal-btn" {% if not profile or not profile.secret_code %}disabled{% endif %}>
                        <i class="fas fa-copy"></i> Copy Code
                    </button>
                    <p class="co-info-note">
                        Share this code only with your residents. They will use it to join your community in VigiLink —
                        enabling them to submit reports, view announcements, check calendar events, and stay updated while
                        you manage members and permissions. Keep this code private to prevent unauthorized access.
                    </p>
                </div>
            </div>
            
            <!-- Events Section -->
            <div id="events" class="content-section" data-loaded="false" style="display:none;">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Event Announcements</h2>
                        <p class="section-subtitle">Create and manage community events and announcements</p>
                    </div>
                </div>
                
                <div class="co-events-controls" style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
                    <div class="co-search-wrap" style="position:relative;flex:1;min-width:280px;display:flex;align-items:center;">
                        <svg class="co-search-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" aria-hidden="true" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#6b7280;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        <input id="co-event-filter" type="text" placeholder="Search events..." style="flex:1;min-width:0;padding:10px 12px 10px 28px;border:1px solid #e5e7eb;border-radius:8px;" />
                    </div>
                    <select id="co-event-type-filter" style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:8px;">
                        <option value="">All Types</option>
                        <option value="announcement">Announcement</option>
                        <option value="meeting">Meeting</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="social">Social Event</option>
                        <option value="emergency">Emergency</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="co-events-list" id="co-events-list">
                    <!-- Events will be loaded here -->
                </div>
                
                <!-- Create Event Button (always visible) -->
                <div class="co-events-create-section" style="margin-top: 20px; text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px; border: 1px solid #e0f2fe;">
                    <button id="co-create-event-btn-bottom" class="action-btn edit-btn" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; font-size: 1rem; border-radius: 8px;">
                        <i class="fas fa-plus"></i> Create New Event
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generic modal overlay shell -->
    <div id="co-modal-overlay" class="co-onboarding-overlay" style="display:none;">
        <div class="co-onboarding-modal" role="dialog" aria-modal="true">
            <div class="co-modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h3 id="co-modal-title" class="co-onboarding-title" style="margin:0;"></h3>
                <button type="button" id="co-modal-close" class="co-modal-close" aria-label="Close">&times;</button>
            </div>
            <div id="co-modal-shell"></div>
        </div>
    </div>

    <!-- Event Creation Modal -->
    <div id="co-event-modal" class="co-onboarding-overlay" style="display:none;">
        <div class="co-onboarding-modal" role="dialog" aria-modal="true" style="max-width: 600px;">
            <div class="co-modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 id="co-event-modal-title" class="co-onboarding-title" style="margin:0;">Create Event Announcement</h3>
                <button type="button" id="co-event-modal-close" class="co-modal-close" aria-label="Close">&times;</button>
            </div>
            <form id="co-event-form" class="co-onboarding-form" novalidate>
                <div class="co-field-row" style="display: flex; gap: 15px;">
                    <div class="co-field" style="flex: 1;">
                        <label for="event_type">Event Type</label>
                        <select id="event_type" name="event_type" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; font-size: 14px; transition: border-color 0.3s ease; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'">
                            <option value="announcement">&#128227; Announcement</option>
                            <option value="meeting">&#128107; Meeting</option>
                            <option value="maintenance">&#128295; Maintenance</option>
                            <option value="social">&#127881; Social Event</option>
                            <option value="emergency">&#128680; Emergency</option>
                            <option value="other">&#128203; Other</option>
                        </select>
                    </div>
                    
                    <div class="co-field" style="flex: 1;">
                        <label for="event_start_date">Event Date & Time *</label>
                        <input type="datetime-local" id="event_start_date" name="start_date" required value="" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; font-size: 14px; transition: border-color 0.3s ease; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'" />
                    </div>
                </div>
                
                <div class="co-field-row" style="display: flex; gap: 15px;">
                    <div class="co-field" style="flex: 1;">
                        <label for="event_title">Event Title *</label>
                        <input type="text" id="event_title" name="title" required placeholder="e.g., Community Meeting" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; font-size: 14px; transition: border-color 0.3s ease; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'" />
                    </div>
                    
                    <div class="co-field" style="flex: 1;">
                        <label for="event_location">Location</label>
                        <input type="text" id="event_location" name="location" placeholder="e.g., Community Center, Block 5" style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; font-size: 14px; transition: border-color 0.3s ease; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'" />
                    </div>
                </div>
                
                <div class="co-field">
                    <label for="event_description">Description *</label>
                    <textarea id="event_description" name="description" required rows="4" placeholder="Describe the event details..." style="padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: #fff; font-size: 14px; resize: vertical; min-height: 100px; transition: border-color 0.3s ease; font-family: inherit; outline: none;" onfocus="this.style.borderColor='#3b82f6'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                </div>
                
                <div class="co-details-actions" style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                    <button type="submit" id="co-event-save" class="action-btn edit-btn">
                        <i class="fas fa-save"></i> Create Event
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Delete Confirmation Modal -->
    <div id="co-delete-confirm-modal" class="co-onboarding-overlay" style="display:none;">
        <div class="co-onboarding-modal" role="dialog" aria-modal="true" style="max-width: 450px;">
            <div class="co-modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <h3 class="co-onboarding-title" style="margin:0;color:#dc2626;">
                    <i class="fas fa-exclamation-triangle" style="margin-right:8px;"></i>
                    Delete Event
                </h3>
                <button type="button" id="co-delete-modal-close" class="co-modal-close" aria-label="Close">&times;</button>
            </div>
            <div style="text-align:center;padding:20px 0;">
                <div style="font-size:48px;color:#fbbf24;margin-bottom:16px;">
                    <i class="fas fa-trash-alt"></i>
                </div>
                <h4 style="margin:0 0 12px 0;color:#374151;font-size:18px;font-weight:600;">Are you sure you want to delete this event?</h4>
                <p style="margin:0 0 20px 0;color:#6b7280;font-size:14px;line-height:1.5;">
                    This action cannot be undone. The event will be permanently removed from your community.
                </p>
                <div style="display:flex;gap:12px;justify-content:center;">
                    <button type="button" id="co-delete-cancel" class="action-btn delete-btn" style="background:#6b7280;color:white;border:none;padding:10px 20px;border-radius:6px;font-size:14px;cursor:pointer;transition:background 0.2s;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" id="co-delete-confirm" class="action-btn delete-btn" style="background:#dc2626;color:white;border:none;padding:10px 20px;border-radius:6px;font-size:14px;cursor:pointer;transition:background 0.2s;">
                        <i class="fas fa-trash"></i> Delete Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Users Bottom Section (no modal) -->
    <div id="co-users-bottom" class="co-users-bottom-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Manage Users</h2>
                <p class="section-subtitle">View members and edit role, block, and lot</p>
            </div>
            <div></div>
        </div>

        <div class="co-users-controls" style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
            <div class="co-search-wrap" style="position:relative;flex:1;min-width:280px;display:flex;align-items:center;">
                <svg class="co-search-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" aria-hidden="true" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#6b7280;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input id="co-user-filter" type="text" placeholder="Filter members by name or email" style="flex:1;min-width:0;padding:10px 12px 10px 28px;border:1px solid #e5e7eb;border-radius:8px;" />
            </div>
            <button id="co-user-add-btn" class="action-btn edit-btn"><i class="fas fa-user-plus"></i> Add User</button>
        </div>

        <div class="co-table-wrap" style="overflow:auto;">
            <table class="co-table" id="co-users-table" style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr style="text-align:left;border-bottom:1px solid #f1f5f9;">
                        <th style="padding:10px 8px;">Full Name</th>
                        <th style="padding:10px 8px;">Role</th>
                        <th style="padding:10px 8px;">Block</th>
                        <th style="padding:10px 8px;">Lot</th>
                        <th style="padding:10px 8px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="co-users-pagination" class="co-users-pagination" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end;padding:10px 0;"></div>
    </div>

    

    {% if needs_onboarding %}
    <div class="co-onboarding-overlay">
        <div class="co-onboarding-modal">
            <h3 class="co-onboarding-title">Set Up Your Community</h3>
            <p class="co-onboarding-subtitle">Please provide your community details to continue.</p>
            <form method="post" class="co-onboarding-form" novalidate>
                {% csrf_token %}
                <div class="co-field">
                    <label for="community_name">Community Name</label>
                    <input type="text" id="community_name" name="community_name" required value="{{ profile.community_name|default:'' }}" autocomplete="off" />
                    <div id="community_name_error" class="co-error-text" style="display:none;">This community name is already taken. Please choose another.</div>
                </div>
                <div class="co-field">
                    <label for="community_address">Community Address</label>
                    <input type="text" id="community_address" name="community_address" required value="{{ profile.community_address|default:'' }}" />
                </div>
                <button type="submit" id="onboarding-submit" class="reveal-btn" style="margin-top: 10px;">
                    Save and Continue
                </button>
            </form>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% comment %} Embed members data for JS {% endcomment %}
{{ members|json_script:"co-members-data" }}
<div id="co-api-endpoints"
     data-list-url="{% url 'communityowner_panel:members_list' %}"
     data-update-url="{% url 'communityowner_panel:member_update' %}"
     data-search-url="{% url 'communityowner_panel:user_search' %}"
     data-add-url="{% url 'communityowner_panel:member_add' %}"
     data-ec-list-url="{% url 'communityowner_panel:emergency_list' %}"
     data-ec-add-url="{% url 'communityowner_panel:emergency_add' %}"
     data-ec-delete-url="{% url 'communityowner_panel:emergency_delete' %}"
     data-ec-update-url="{% url 'communityowner_panel:emergency_update' %}"
     data-reports-list-url="{% url 'communityowner_panel:reports_list' %}"
     data-reports-download-pdf-url="{% url 'communityowner_panel:reports_download_pdf' %}"
     data-reports-analytics-url="{% url 'communityowner_panel:reports_analytics' %}"
     data-events-list-url="{% url 'events_panel:get_events' %}"
     data-events-create-url="{% url 'events_panel:create_event' %}"
     data-events-update-url="{% url 'events_panel:update_event' 0 %}"
     data-events-delete-url="{% url 'events_panel:delete_event' 0 %}"></div>
<div id="co-messages-data" data-messages='[{% if messages %}{% for message in messages %}{"text":"{{ message|escapejs }}","tags":"{{ message.tags|default:"info" }}"}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}]'></div>
<script defer src="{% static 'communityowner/js/communityowner_script.js' %}" onload="window.CO_SCRIPT_LOADED=true;"></script>
<script defer src="{% static 'communityowner/js/events_management.js' %}" onload="window.EVENTS_MANAGEMENT_LOADED=true;"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Prevent modal from closing when clicking outside
    const eventModal = document.getElementById('co-event-modal');
    const eventModalOverlay = eventModal;
    
    if (eventModalOverlay) {
        eventModalOverlay.addEventListener('click', function(e) {
            // Only close if clicking the overlay itself, not the modal content
            if (e.target === eventModalOverlay) {
                e.preventDefault();
                e.stopPropagation();
                // Don't close the modal
            }
        });
    }
    
    // Events section and modal are now available on all devices
    
    // Ensure content area is hidden
    const contentArea = document.querySelector('.content-area');
    if (contentArea) {
        contentArea.style.display = 'none';
    }
});
</script>
{% endblock %}



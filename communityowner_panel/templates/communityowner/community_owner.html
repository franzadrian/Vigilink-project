{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}My Community - VigiLink{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'communityowner/css/communityowner_styles.css' %}">
{% endblock %}

{% block content %}
    <div class="container">
        <header class="co-hero">
            <div class="co-logo">
                <div class="co-logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
            <h1>My Community</h1>
            <p class="subtitle">Complete overview of users, reports, and analytics</p>
        </header>
        
        <!-- Stats Section -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-users">0</h3>
                    <p>Total Users</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon reports">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stat-info">
                    <h3 id="total-reports">0</h3>
                    <p>Total Reports</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon active">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3 id="active-reports">0</h3>
                    <p>Active Reports</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon week">
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="stat-info">
                    <h3 id="week-reports">0</h3>
                    <p>Last Week Reports</p>
                </div>
            </div>
        </div>
        
        <div class="nav-cards">
            <div class="nav-card active" data-target="details">
                <div class="card-icon">
                    <i class="fas fa-building"></i>
                </div>
                <div class="card-title">Community Details</div>
                <div class="card-desc">View and edit your community info</div>
            </div>

            <div class="nav-card" data-target="secret">
                <div class="card-icon">
                    <i class="fas fa-key"></i>
                </div>
                <div class="card-title">My Community Code</div>
                <div class="card-desc">Your permanent owner code (private)</div>
            </div>
            
            <div class="nav-card" data-target="reports">
                <div class="card-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="card-title">View Reports</div>
                <div class="card-desc">Analyze performance and activity data</div>
            </div>
        </div>
        
        <div class="content-area" style="display:none;">
            <!-- Community Details Section -->
            <div id="details" class="content-section active">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Community Details</h2>
                        <p class="section-subtitle">Your community information</p>
                    </div>
                    <div></div>
                </div>

                <!-- Inline edit form -->
                <form id="co-details-form" method="post" class="co-details-card" novalidate>
                    {% csrf_token %}
                    <div class="co-details-grid">
                        <div class="co-field">
                            <label for="edit_community_name">Community Name</label>
                            <input type="text" id="edit_community_name" name="community_name" required value="{{ profile.community_name|default:'' }}" autocomplete="off" placeholder="e.g., Greenfield Village" />
                            <div id="edit_community_name_error" class="co-error-text" style="display:none;">This community name is already taken. Please choose another.</div>
                        </div>
                        <div class="co-field">
                            <label for="edit_community_address">Community Address</label>
                            <input type="text" id="edit_community_address" name="community_address" required value="{{ profile.community_address|default:'' }}" placeholder="e.g., 123 Palm St, Springfield" />
                        </div>
                    </div>
                    <div class="co-details-actions" id="co-inline-actions" style="display:none;">
                        <button type="submit" id="co-details-save" class="action-btn edit-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="button" id="co-details-cancel" class="action-btn delete-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Users Section -->
            <div id="users" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">User Management</h2>
                        <p class="section-subtitle">Manage all user accounts and permissions</p>
                    </div>
                    <div></div>
                </div>
                <div class="user-grid" style="display:none;"></div>
            </div>
            
            <!-- Reports Section -->
            <div id="reports" class="content-section">
                <div class="section-header">
                    <div>
                        <h2 class="section-title">Reports & Analytics</h2>
                        <p class="section-subtitle">View and analyze system reports</p>
                    </div>
                </div>
                
                <div class="report-list">
                    <!-- Report cards will be dynamically generated -->
                </div>
            </div>
            
            
            
            <!-- Secret Code Section -->
            <div id="secret" class="content-section">
                <div class="secret-container">
                    <div class="secret-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h2 class="section-title">My Community Code</h2>
                    <p class="section-subtitle">This is your permanent owner code. Keep it private.</p>
                    <div id="code-display" class="code-display {% if profile and profile.secret_code %}revealed{% endif %}"
                         data-code="{{ profile.secret_code|default:'' }}">{{ profile.secret_code|default:'' }}</div>
                    <button id="copy-code-btn" class="reveal-btn" {% if not profile or not profile.secret_code %}disabled{% endif %}>
                        <i class="fas fa-copy"></i> Copy Code
                    </button>
                    <p class="co-info-note">
                        Share this code only with your residents. They will use it to join your community in VigiLink â€”
                        enabling them to submit reports, view announcements, check calendar events, and stay updated while
                        you manage members and permissions. Keep this code private to prevent unauthorized access.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Generic modal overlay shell -->
    <div id="co-modal-overlay" class="co-onboarding-overlay" style="display:none;">
        <div class="co-onboarding-modal" role="dialog" aria-modal="true">
            <div class="co-modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h3 id="co-modal-title" class="co-onboarding-title" style="margin:0;"></h3>
                <button type="button" id="co-modal-close" class="co-modal-close" aria-label="Close">&times;</button>
            </div>
            <div id="co-modal-shell"></div>
        </div>
    </div>

    <!-- Manage Users Bottom Section (no modal) -->
    <div id="co-users-bottom" class="co-users-bottom-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Manage Users</h2>
                <p class="section-subtitle">View members and edit role, block, and lot</p>
            </div>
            <div></div>
        </div>

        <div class="co-users-controls" style="display:flex;gap:10px;align-items:center;margin-bottom:15px;">
            <div class="co-search-wrap" style="position:relative;flex:1;min-width:280px;display:flex;align-items:center;">
                <svg class="co-search-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" aria-hidden="true" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#6b7280;pointer-events:none;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input id="co-user-filter" type="text" placeholder="Filter members by name or email" style="flex:1;min-width:0;padding:10px 12px 10px 28px;border:1px solid #e5e7eb;border-radius:8px;" />
            </div>
            <button id="co-user-add-btn" class="action-btn edit-btn"><i class="fas fa-user-plus"></i> Add User</button>
        </div>

        <div class="co-table-wrap" style="overflow:auto;">
            <table class="co-table" id="co-users-table" style="width:100%;border-collapse:collapse;">
                <thead>
                    <tr style="text-align:left;border-bottom:1px solid #f1f5f9;">
                        <th style="padding:10px 8px;">Full Name</th>
                        <th style="padding:10px 8px;">Role</th>
                        <th style="padding:10px 8px;">Block</th>
                        <th style="padding:10px 8px;">Lot</th>
                        <th style="padding:10px 8px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="co-users-pagination" class="co-users-pagination" style="display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end;padding:10px 0;"></div>
    </div>

    

    {% if needs_onboarding %}
    <div class="co-onboarding-overlay">
        <div class="co-onboarding-modal">
            <h3 class="co-onboarding-title">Set Up Your Community</h3>
            <p class="co-onboarding-subtitle">Please provide your community details to continue.</p>
            <form method="post" class="co-onboarding-form" novalidate>
                {% csrf_token %}
                <div class="co-field">
                    <label for="community_name">Community Name</label>
                    <input type="text" id="community_name" name="community_name" required value="{{ profile.community_name|default:'' }}" autocomplete="off" />
                    <div id="community_name_error" class="co-error-text" style="display:none;">This community name is already taken. Please choose another.</div>
                </div>
                <div class="co-field">
                    <label for="community_address">Community Address</label>
                    <input type="text" id="community_address" name="community_address" required value="{{ profile.community_address|default:'' }}" />
                </div>
                <button type="submit" id="onboarding-submit" class="reveal-btn" style="margin-top: 10px;">
                    Save and Continue
                </button>
            </form>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
{{ block.super }}
{% comment %} Embed members data for JS {% endcomment %}
{{ members|json_script:"co-members-data" }}
<div id="co-api-endpoints"
     data-list-url="{% url 'communityowner_panel:members_list' %}"
     data-update-url="{% url 'communityowner_panel:member_update' %}"
     data-search-url="{% url 'communityowner_panel:user_search' %}"
     data-add-url="{% url 'communityowner_panel:member_add' %}"></div>
<div id="co-messages-data" data-messages='[{% if messages %}{% for message in messages %}{"text":"{{ message|escapejs }}","tags":"{{ message.tags|default:"info" }}"}{% if not forloop.last %},{% endif %}{% endfor %}{% endif %}]'></div>
<script defer src="{% static 'communityowner/js/communityowner_script.js' %}"></script>
{% endblock %}


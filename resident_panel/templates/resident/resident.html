{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Residents - VigiLink{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'resident/css/resident.css' %}">
{% endblock %}

{% block content %}
  <div class="resident-page">
    <div class="resident-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
        <div style="flex: 1;">
          <h1 class="resident-heading">Community Residents</h1>
          {% if community and community.community_name %}
          {% if request.user.role == 'communityowner' or request.user.role == 'admin' %}
          <p class="resident-subtitle">View and manage community members in {{ community.community_name }}</p>
          {% else %}
          <p class="resident-subtitle">View community members in {{ community.community_name }}</p>
          {% endif %}
          {% endif %}
        </div>
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
          {% if request.user.profile_picture_url %}
            <img src="{{ request.user.profile_picture_url }}?{% now 'U' %}" alt="{{ request.user.full_name|default:request.user.username }}" class="resident-profile-picture" onerror="this.src='/static/accounts/images/profile.png'">
          {% elif request.user.profile_picture %}
            <img src="{{ request.user.profile_picture.url }}?{% now 'U' %}" alt="{{ request.user.full_name|default:request.user.username }}" class="resident-profile-picture" onerror="this.src='/static/accounts/images/profile.png'">
          {% else %}
            <img src="{% static 'accounts/images/profile.png' %}" alt="{{ request.user.full_name|default:request.user.username }}" class="resident-profile-picture">
          {% endif %}
          {% if request.user.role != 'security' %}
          <a href="{% url 'resident_panel:my_reports' %}" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 6px; text-decoration: none;">
            <i class="fas fa-file-alt"></i>
            <span>My Reports</span>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="resident-toolbar">
      <div class="resident-search">
        <label for="resident-search-input" class="sr-only">Search residents</label>
        <div class="search-input-wrap">
          <svg class="search-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input id="resident-search-input" type="text" placeholder="Search residents..." autocomplete="off">
        </div>
      </div>
      <div class="resident-toolbar-actions">
        {% if request.user.role != 'security' %}
        <span class="res-inline-help-text">Found a suspicious person or activity?</span>
        <div class="resident-toolbar-buttons">
          <a href="{% url 'resident_panel:my_reports' %}" class="btn btn-primary" style="display: none; align-items: center; gap: 6px; text-decoration: none;">
            <i class="fas fa-file-alt"></i>
            <span>My Reports</span>
          </a>
          <button type="button" class="btn btn-danger resident-report-incident-btn">Report Incident</button>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="resident-table-card">
      <div class="resident-table-wrap">
        <table class="resident-table">
          <thead>
            <tr>
              <th>Resident</th>
              <th>Block/Lot</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody id="resident-table-body">
            <!-- Rows rendered by resident.js -->
          </tbody>
        </table>
      </div>
    </div>
    <div id="resident-pagination" class="resident-pagination"></div>
    
    <!-- Emergency Calls and Safety Tip for guest users -->
    {% if not community %}
    <div class="guest-info-section">
      <div class="guest-emergency-card">
        <header class="guest-card-header">
          <div class="guest-card-title">
            <i class="fa-solid fa-phone" aria-hidden="true"></i>
            <span>Emergency Calls</span>
          </div>
        </header>
        <div class="guest-card-body">
          <ul class="guest-contacts-list">
            <li class="guest-contact-item">
              <span class="guest-contact-label">Police Emergency</span>
              <a class="guest-contact-number" href="tel:166"><i class="fa-solid fa-phone"></i> 166</a>
            </li>
            <li class="guest-contact-item">
              <span class="guest-contact-label">Fire Department</span>
              <a class="guest-contact-number" href="tel:160"><i class="fa-solid fa-phone"></i> 160</a>
            </li>
            <li class="guest-contact-item">
              <span class="guest-contact-label">Hospital Emergency</span>
              <a class="guest-contact-number" href="tel:161"><i class="fa-solid fa-phone"></i> 161</a>
            </li>
            <li class="guest-contact-item">
              <span class="guest-contact-label">Emergency Hotline</span>
              <a class="guest-contact-number" href="tel:911"><i class="fa-solid fa-phone"></i> 911</a>
            </li>
          </ul>
        </div>
      </div>
      
      <div class="guest-safety-card">
        <header class="guest-card-header">
          <div class="guest-card-title">
            <i class="fa-solid fa-shield-halved" aria-hidden="true"></i>
            <span>Safety Tip</span>
          </div>
        </header>
        <div class="guest-card-body">
          <p class="guest-safety-tip">Always verify the identity of service personnel before allowing them into your home. Ask for official identification and call their company to confirm their visit.</p>
          <p class="guest-safety-note">Join a community to get personalized safety tips and emergency contacts for your area.</p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
{{ residents|json_script:"residents-data" }}
<div id="residents-flags" data-is-owner="{% if is_owner %}1{% else %}0{% endif %}" data-is-security="{% if is_security %}1{% else %}0{% endif %}" data-remove-url="{% url 'communityowner_panel:member_remove' %}" data-report-url="{% url 'resident_panel:submit_report' %}" data-profile-base-url="{% url 'user_panel:view_user_profile' 999999 %}"></div>
{% if toast %}
{{ toast|json_script:"res-toast-json" }}
{% endif %}
<!-- Modal overlay for resident page -->
<div id="res-modal-overlay" class="res-modal-overlay" style="display:none;">
  <div class="res-modal" role="dialog" aria-modal="true" aria-labelledby="res-modal-title">
    <div class="res-modal-header">
      <div id="res-modal-title" class="res-modal-title"></div>
      <button id="res-modal-close" class="res-modal-close" aria-label="Close">&times;</button>
    </div>
    <div id="res-modal-body" class="res-modal-body"></div>
    <div id="res-modal-actions" class="res-modal-actions"></div>
  </div>
  
</div>
<script defer src="{% static 'resident/js/user_resident.js' %}"></script>
{% endblock %}

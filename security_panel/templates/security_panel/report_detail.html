{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Report #{{ report.id }} - VigiLink{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'security_panel/css/security.css' %}">
{% endblock %}

{% block content %}
<div class="report-view">
  <!-- Top Navigation -->
  <div class="report-nav">
    <a href="{% url 'security_panel:dashboard' %}" class="nav-back" id="back-to-dashboard">
      <i class="fa-solid fa-arrow-left"></i>
      Back
    </a>
    <div class="report-id">Report #{{ report.id }}</div>
  </div>

  <!-- Status Banner with Update Form -->
  <div class="status-banner status-{{ report.status }}">
    <div class="banner-content">
      <div class="banner-left">
        <div class="banner-status-row">
          <div class="banner-status">{{ report.get_status_display }}</div>
          <div class="banner-priority priority-{{ report.priority }}">
            {{ report.get_priority_display }}
          </div>
        </div>
        <div class="banner-date">{{ report.created_at|date:"F d, Y â€¢ h:i A" }}</div>
        <form id="report-update-form" class="banner-update-form">
          {% csrf_token %}
          <div class="banner-form-field">
            <label for="status">Update Status</label>
            <div class="banner-form-controls">
              <select id="status" name="status" class="banner-status-select">
                {% for value, label in report.STATUS_CHOICES %}
                <option value="{{ value }}" {% if report.status == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
              <button type="submit" class="banner-update-btn">
                Update
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="report-grid">
    <!-- Incident Information Card -->
    <div class="info-card">
      <div class="card-header">
        <i class="fa-solid fa-circle-exclamation"></i>
        <h3>Incident Information</h3>
      </div>
      <div class="card-body">
        <div class="info-field">
          <div class="field-label">Complainee</div>
          <div class="field-value">
            {% if report.target_type == 'resident' and report.target_user %}
              {{ report.target_user.full_name|default:report.target_user.username }}
            {% else %}
              Non-resident / Outsider
            {% endif %}
          </div>
        </div>
        <div class="info-field">
          <div class="field-label">Location</div>
          <div class="field-value">
            {% if report.location and report.location.strip %}
              {{ report.location }}
            {% elif report.target_type == 'resident' and report.target_user and report.target_user.block and report.target_user.lot %}
              Block {{ report.target_user.block }}, Lot {{ report.target_user.lot }}
            {% else %}
              N/A
            {% endif %}
          </div>
        </div>
        <div class="info-field">
          <div class="field-label">Reason</div>
          <div class="field-value">
            {% if report.reasons %}
              {% if "Other (please specify)" in report.reasons %}
                {% if report.details and report.details.strip %}
                  {{ report.details }}
                {% else %}
                  {{ report.get_reasons_display }}
                {% endif %}
              {% else %}
                {{ report.get_reasons_display }}
              {% endif %}
            {% else %}
              {{ report.get_reasons_display }}
            {% endif %}
          </div>
        </div>
        {% if not report.reasons or "Other (please specify)" not in report.reasons %}
          {% if report.details and report.details.strip %}
            <div class="info-field">
              <div class="field-label">Details</div>
              <div class="field-value">{{ report.details|linebreaks }}</div>
            </div>
          {% elif report.message and report.message.strip %}
            <div class="info-field">
              <div class="field-label">Details</div>
              <div class="field-value">
                {% if "Target Details:" in report.message %}
                  {{ report.message|cut:"Target Details:"|cut:"Details: "|linebreaks }}
                {% else %}
                  {{ report.message|cut:"Details: "|linebreaks }}
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>

    <!-- Complainant Information Card -->
    <div class="info-card">
      <div class="card-header">
        <i class="fa-solid fa-user"></i>
        <h3>Complainant</h3>
      </div>
      <div class="card-body">
        <div class="info-field">
          <div class="field-label">Name</div>
          <div class="field-value">
            {% if report.is_anonymous %}
              Anonymous
            {% else %}
              {{ report.get_reporter_display }}
            {% endif %}
          </div>
        </div>
        {% if not report.is_anonymous and report.reporter.block and report.reporter.lot %}
        <div class="info-field">
          <div class="field-label">Block & Lot</div>
          <div class="field-value">Block {{ report.reporter.block }}, Lot {{ report.reporter.lot }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'security_panel/js/security.js' %}"></script>
<script>
  // Report-specific JavaScript
  document.addEventListener('DOMContentLoaded', function() {
    const reportId = parseInt('{{ report.id }}', 10);
    const updateUrl = "{% url 'security_panel:update_report_status' report.id %}";
    
    // Ensure audio context is ready when user clicks Back button
    // This preserves user interaction state for notifications
    const backButton = document.getElementById('back-to-dashboard');
    if (backButton) {
      backButton.addEventListener('click', function(e) {
        // Create or resume audio context before navigation to ensure notifications work
        // This preserves the user interaction state across page navigation
        try {
          // Create audio context if it doesn't exist
          if (typeof window.globalAudioContext === 'undefined' || !window.globalAudioContext || window.globalAudioContext.state === 'closed') {
            window.globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('Created audio context before navigation');
          }
          
          // Always try to resume to ensure it's running
          if (window.globalAudioContext && window.globalAudioContext.state === 'suspended') {
            window.globalAudioContext.resume().then(() => {
              console.log('Audio context resumed before navigation, state:', window.globalAudioContext.state);
              // Mark as unlocked in localStorage
              localStorage.setItem('security_audio_unlocked', 'true');
              // Also mark with timestamp to ensure it's recent
              localStorage.setItem('security_audio_unlocked_time', Date.now().toString());
            }).catch(err => {
              console.log('Could not resume audio context:', err);
            });
          } else if (window.globalAudioContext && window.globalAudioContext.state === 'running') {
            // Already running, mark as unlocked
            localStorage.setItem('security_audio_unlocked', 'true');
            localStorage.setItem('security_audio_unlocked_time', Date.now().toString());
            console.log('Audio context already running, marked as unlocked');
          }
        } catch (err) {
          console.log('Error handling audio context before navigation:', err);
        }
        
        // Also try to resume via the security.js function if available
        if (typeof window.resumeAllAudioContexts === 'function') {
          window.resumeAllAudioContexts();
        }
      });
    }
    
    // Handle form submission
    document.getElementById('report-update-form').addEventListener('submit', function(e) {
      e.preventDefault();
      updateReportStatus(reportId, updateUrl);
    });
  });
</script>
{% endblock %}

{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Security Dashboard - VigiLink{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'security_panel/css/security.css' %}">
{% endblock %}

{% block content %}
<div class="security-dashboard">
  <header class="security-header">
    <div class="security-title-wrap">
      <h1 class="security-title">Security Dashboard</h1>
      <p class="security-subtitle">{{ community.community_name }} - Incident Reports</p>
    </div>
    <form method="GET" class="filters-form">
      <div class="filter-group">
        <label for="status">Status</label>
        <select id="status" name="status">
          <option value="">All Status</option>
          <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
          <option value="investigating" {% if status_filter == 'investigating' %}selected{% endif %}>Under Investigation</option>
          <option value="resolved" {% if status_filter == 'resolved' %}selected{% endif %}>Resolved</option>
          <option value="false_alarm" {% if status_filter == 'false_alarm' %}selected{% endif %}>False Alarm</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="priority">Priority</label>
        <select id="priority" name="priority">
          <option value="">All Priority</option>
          <option value="level_1" {% if priority_filter == 'level_1' %}selected{% endif %}>Level 1</option>
          <option value="level_2" {% if priority_filter == 'level_2' %}selected{% endif %}>Level 2</option>
          <option value="level_3" {% if priority_filter == 'level_3' %}selected{% endif %}>Level 3</option>
        </select>
      </div>
    </form>
  </header>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card stat-card--total">
      <div class="stat-icon"><i class="fa-solid fa-clipboard-list" aria-hidden="true"></i></div>
      <div class="stat-content">
        <h3>Total Reports</h3>
        <div class="stat-value">{{ stats.total_reports }}</div>
      </div>
    </div>

    <div class="stat-card stat-card--new">
      <div class="stat-icon"><i class="fa-solid fa-exclamation-circle" aria-hidden="true"></i></div>
      <div class="stat-content">
        <h3>Pending Reports</h3>
        <div class="stat-value">{{ stats.new_reports }}</div>
      </div>
    </div>

    <div class="stat-card stat-card--false-alarm">
      <div class="stat-icon"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i></div>
      <div class="stat-content">
        <h3>False Alarm</h3>
        <div class="stat-value">{{ stats.false_alarm }}</div>
      </div>
    </div>

    <div class="stat-card stat-card--resolved">
      <div class="stat-icon"><i class="fa-solid fa-check-circle" aria-hidden="true"></i></div>
      <div class="stat-content">
        <h3>Resolved</h3>
        <div class="stat-value">{{ stats.resolved }}</div>
      </div>
    </div>
  </div>

  <!-- Reports Table -->
  <div class="reports-section">
    <div class="reports-header">
      <h2>Incident Reports</h2>
      <div class="reports-count">{{ page_obj.paginator.count }} report{{ page_obj.paginator.count|pluralize }}</div>
    </div>

    {% if page_obj %}
    <div class="reports-table-container">
      <table class="reports-table">
        <thead>
          <tr>
            <th>Complainant</th>
            <th>Reason</th>
            <th>Complainee</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for report in page_obj %}
          <tr class="report-row {% if report.status == 'pending' %}pending-highlight{% endif %}">
            <td class="report-reporter">
              <div class="reporter-name">{{ report.get_reporter_display }}</div>
            </td>
            <td class="report-subject">
              <div class="subject-text">
                {% if report.target_type == 'outsider' and report.public_incident %}
                  {% if report.public_incident.incident_type == 'other' %}
                    {{ report.details|truncatechars:40 }}
                  {% else %}
                    {{ report.public_incident.get_incident_type_display_short }}
                  {% endif %}
                {% else %}
                  {% with priority_reason=report.get_priority_reason %}
                    {% if priority_reason %}
                      {% if priority_reason == "Other (please specify)" %}
                        {% if report.details and report.details.strip %}
                          {{ report.details|truncatechars:40 }}
                        {% else %}
                          {{ priority_reason|truncatechars:40 }}
                        {% endif %}
                      {% else %}
                        {{ priority_reason|truncatechars:40 }}
                      {% endif %}
                    {% else %}
                      Report
                    {% endif %}
                  {% endwith %}
                {% endif %}
              </div>
            </td>
            <td class="report-target">
              {% if report.target_type == 'resident' and report.target_user %}
                <div class="target-name">{{ report.target_user.full_name|default:report.target_user.username }}</div>
              {% else %}
                <div class="target-badge target-outsider">Non-Resident</div>
              {% endif %}
            </td>
            <td class="report-status">
              <span class="status-badge status-{{ report.status }}">{{ report.get_status_display }}</span>
            </td>
            <td class="report-actions">
              <a href="{% url 'security_panel:report_detail' report.id %}" class="btn btn-view">
                <i class="fa-solid fa-eye"></i>
                <span>View</span>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">Previous</a>
      {% endif %}
      
      <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
      
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if priority_filter %}&priority={{ priority_filter }}{% endif %}">Next</a>
      {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
      <div class="empty-icon"><i class="fa-solid fa-clipboard-list"></i></div>
      <h3>No Reports Found</h3>
      <p>No incident reports match your current filters.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- Security Dashboard Data -->
<script type="application/json" id="security-dashboard-data">
{
  "userRole": "{{ request.user.role }}",
  "initialMaxReportId": {{ initial_max_report_id }},
  "notificationSoundEnabled": {% if request.user.notification_sound_enabled %}true{% else %}false{% endif %}
}
</script>
<script>
    // Pass user role and notification settings to JavaScript
    (function() {
        const dataEl = document.getElementById('security-dashboard-data');
        if (dataEl) {
            try {
                const data = JSON.parse(dataEl.textContent);
                window.userRole = data.userRole;
                window.initialMaxReportId = data.initialMaxReportId;
                window.notificationSoundEnabled = data.notificationSoundEnabled;
            } catch (e) {
                console.error('Error parsing security dashboard data:', e);
                // Fallback values
                window.userRole = '';
                window.initialMaxReportId = 0;
                window.notificationSoundEnabled = false;
            }
        } else {
            // Fallback if element doesn't exist
            window.userRole = '';
            window.initialMaxReportId = 0;
            window.notificationSoundEnabled = false;
        }
    })();
</script>
<script src="{% static 'security_panel/js/security.js' %}"></script>
{% endblock %}

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verification - VigiLink</title>
    <link rel="stylesheet" href="{% static 'accounts/css/verification_styles.css' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'favicon/shield.svg' %}">
<link rel="apple-touch-icon" href="{% static 'favicon/shield.svg' %}">
<link rel="manifest" href="{% static 'favicon/site.webmanifest' %}">
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <a href="/" style="text-decoration: none; color: inherit; display: flex; align-items: center;">
                    <img src="{% static 'accounts/images/vigilink_logo.png' %}" alt="VigiLink Logo" class="logo-image">
                    <span>VigiLink</span>
                </a>
            </div>
            <nav class="nav">
                <a href="{% url 'user_panel:about' %}">About</a>
                <a href="{% url 'user_panel:contact' %}">Contact</a>
                <a href="{% url 'user_panel:pricing' %}">Pricing</a>
            </nav>
            
            <div class="menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>

            <div class="mobile-nav" id="mobileNav">
                <a href="{% url 'user_panel:about' %}">About</a>
                <a href="{% url 'user_panel:contact' %}">Contact</a>
                <a href="{% url 'user_panel:pricing' %}">Pricing</a>
            </div>
        </div>
    </header>

    <main class="main-container">
        <div class="verification-card">
            <h1 class="verification-title">VERIFICATION</h1>
            
            <form method="post" action="{% url 'verify_email' %}">
                {% csrf_token %}
                <div class="code-input-container">
                    <input type="text" class="code-input" name="digit1" maxlength="1" required />
                    <input type="text" class="code-input" name="digit2" maxlength="1" required />
                    <input type="text" class="code-input" name="digit3" maxlength="1" required />
                    <input type="text" class="code-input" name="digit4" maxlength="1" required />
                    <input type="text" class="code-input" name="digit5" maxlength="1" required />
                    <input type="text" class="code-input" name="digit6" maxlength="1" required />
                </div>

                <div class="verification-text">
                    <div class="subject-line">Subject: Email Verification Required</div>
                    <div>To complete your registration, please enter the 6-digit code sent to your email address.</div>
                    
                    {% if email_send_failed and verification_code %}
                    <div style="background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
                        <div style="font-weight: bold; color: #856404; margin-bottom: 10px;">
                            ⚠️ Email Not Sent
                        </div>
                        <div style="color: #856404; margin-bottom: 10px;">
                            Email service is not available. Please use this verification code:
                        </div>
                        <div style="font-size: 32px; font-weight: bold; color: #000; letter-spacing: 8px; font-family: 'Courier New', monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; display: inline-block;">
                            {{ verification_code }}
                        </div>
                        {% if email_error %}
                        <div style="font-size: 12px; color: #666; margin-top: 10px;">
                            Error: {{ email_error }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if messages %}
                    <div class="messages">
                        {% for message in messages %}
                        <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
                            {{ message }}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <div class="button-container">
                    <button type="submit" class="continue-btn">Verify Email</button>
                </div>
            </form>
            
            <form method="post" action="{% url 'resend_verification_code' %}" class="resend-form">
                {% csrf_token %}
                <button type="submit" class="resend-btn">Re-Send Code</button>
            </form>
        </div>

    </main>

    <script>
        // JavaScript for code input functionality
        const codeInputs = document.querySelectorAll('.code-input');
        
        // Handle paste across all boxes: distribute digits sequentially
        const container = document.querySelector('.code-input-container');
        if (container) {
            container.addEventListener('paste', (e) => {
                const pasted = (e.clipboardData || window.clipboardData).getData('text') || '';
                const digits = pasted.replace(/\D/g, '').slice(0, codeInputs.length);
                if (!digits) return; // let default if no digits
                e.preventDefault();
                // Fill from the first input
                for (let i = 0; i < codeInputs.length; i++) {
                    codeInputs[i].value = digits[i] || '';
                }
                // Focus next empty or blur if all filled
                const nextEmptyIndex = Array.from(codeInputs).findIndex(inp => inp.value === '');
                if (nextEmptyIndex !== -1) {
                    codeInputs[nextEmptyIndex].focus();
                } else {
                    codeInputs[codeInputs.length - 1].blur();
                }
            });
        }

        codeInputs.forEach((input, index) => {
            // Auto-focus on first input when page loads
            if (index === 0) {
                setTimeout(() => input.focus(), 500);
            }
            
            // Move to next input after entering a digit
            input.addEventListener('input', (e) => {
                // Only allow numbers
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                
                if (e.target.value.length === 1) {
                    if (index < codeInputs.length - 1) {
                        codeInputs[index + 1].focus();
                    } else {
                        // If it's the last input, blur to hide keyboard on mobile
                        input.blur();
                        // Optional: auto-submit the form when all digits are filled
                        // document.querySelector('form').submit();
                    }
                }
            });
            
            // Handle backspace to go to previous input
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
            
            // Select all text when focused
            input.addEventListener('focus', (e) => {
                setTimeout(() => e.target.select(), 0);
            });
        });

        // Mobile menu toggle
        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobileNav');
            const menuToggle = document.querySelector('.menu-toggle');
            
            if (!menuToggle.contains(event.target) && !mobileNav.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        // Auto-hide verification messages after 4 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const messages = document.querySelectorAll('.message');
            if (messages.length > 0) {
                setTimeout(function() {
                    messages.forEach(message => {
                        message.style.display = 'none';
                    });
                }, 4000);
            }
        });

        // 60-second cooldown for resend button
        const resendBtn = document.querySelector('.resend-btn');
        const resendForm = document.querySelector('.resend-form');
        if (resendBtn && resendForm) {
            let cooldownActive = false;
            let cooldownTime = 60; // seconds
            let cooldownInterval;
            
            // Check if we have a stored timestamp and it's less than 60 seconds ago
            const lastResendTime = localStorage.getItem('lastResendTime');
            if (lastResendTime) {
                const elapsedSeconds = Math.floor((Date.now() - parseInt(lastResendTime)) / 1000);
                if (elapsedSeconds < cooldownTime) {
                    startCooldown(cooldownTime - elapsedSeconds);
                }
            }
            
            resendBtn.addEventListener('click', function(e) {
                if (cooldownActive) {
                    e.preventDefault();
                    return;
                }
                
                // Store the current timestamp
                localStorage.setItem('lastResendTime', Date.now().toString());
                startCooldown(cooldownTime);
                
                // Submit the form
                resendForm.submit();
            });
            
            function startCooldown(remainingSeconds) {
                cooldownActive = true;
                resendBtn.disabled = true;
                const originalText = resendBtn.textContent;
                
                function updateCooldownText() {
                    resendBtn.textContent = `Wait ${remainingSeconds}s`;
                    remainingSeconds--;
                    
                    if (remainingSeconds < 0) {
                        clearInterval(cooldownInterval);
                        resendBtn.textContent = originalText;
                        resendBtn.disabled = false;
                        cooldownActive = false;
                    }
                }
                
                updateCooldownText();
                cooldownInterval = setInterval(updateCooldownText, 1000);
            }
        }
    </script>
</body>
</html>

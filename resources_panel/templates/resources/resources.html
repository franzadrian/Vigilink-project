{% extends 'dashboard/base.html' %}
{% load static %}
{% load resource_tags %}

{% block title %}Resources - VigiLink{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'resources/css/resources.css' %}">
{% endblock %}

{% block content %}
<div class="resources-page">
    <div class="page-header">
        <div class="page-title">
            <h1>Resources</h1>
            <p>Access PDFs, images, videos, and helpful links shared by your community administrators</p>
        </div>
    </div>

    <div class="resources-container">
        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-box">
                <div class="search-form">
                    <input type="text" id="search-input" placeholder="Search resources by title..." value="{{ search_query }}" class="search-input">
                    <button type="button" id="search-btn" class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if search_query %}
                        <button type="button" id="clear-search-btn" class="clear-search" title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <div class="filter-buttons">
                <button type="button" class="filter-btn {% if filter_type == 'all' %}active{% endif %}" data-filter-type="all">
                    All
                </button>
                <button type="button" class="filter-btn {% if filter_type == 'image' %}active{% endif %}" data-filter-type="image">
                    Images
                </button>
                <button type="button" class="filter-btn {% if filter_type == 'video' %}active{% endif %}" data-filter-type="video">
                    Videos
                </button>
                <button type="button" class="filter-btn {% if filter_type == 'link' %}active{% endif %}" data-filter-type="link">
                    External Links
                </button>
                <button type="button" class="filter-btn {% if filter_type == 'document' %}active{% endif %}" data-filter-type="document">
                    Documents
                </button>
            </div>
        </div>
        
        <!-- Resources List -->
        <div class="resources-list-section">
            <div class="section-header">
                <h2>Existing Resources (<span id="resources-count">{{ total_count }}</span>)</h2>
            </div>
            
            <div id="resources-container">
            {% if resources %}
                <div class="resources-grid" id="resources-grid">
                {% for resource in resources %}
                    {% with file_url=resource_urls|get_item:resource.id group_id=resource_group_ids|get_item:resource.id %}
                    <div class="resource-card" {% if group_id %}data-group-id="{{ group_id }}"{% endif %}>
                        <div class="resource-header">
                            <h3>{% if "(Image" in resource.title %}{{ resource.title|slice:":-11" }}{% else %}{{ resource.title }}{% endif %}</h3>
                            <span class="resource-type {{ resource.resource_type }}">{{ resource.get_resource_type_display }}</span>
                        </div>
                        
                        {% if resource.description %}
                            <p class="resource-description">
                                {% if "[GROUP_ID:" in resource.description %}
                                    {{ resource.description|slice:":-36"|slice:":-11" }}
                                {% else %}
                                    {{ resource.description }}
                                {% endif %}
                            </p>
                        {% endif %}
                        
                        <!-- Resource Preview -->
                        {% if resource.resource_type == 'image' and resource.file %}
                            <div class="resource-preview">
                                <div class="image-gallery-container">
                                    {% if file_url and file_url != '' %}
                                        <img src="{{ file_url }}" alt="{{ resource.title }}" class="resource-image clickable-image" data-image-url="{{ file_url }}" data-image-title="{{ resource.title }}" {% if group_id %}data-group-id="{{ group_id }}"{% endif %}>
                                    {% else %}
                                        <img src="{{ resource.file.url }}" alt="{{ resource.title }}" class="resource-image clickable-image" data-image-url="{{ resource.file.url }}" data-image-title="{{ resource.title }}" {% if group_id %}data-group-id="{{ group_id }}"{% endif %}>
                                    {% endif %}
                                    {% if group_id %}
                                        {% with group_count=resource_group_counts|get_item:resource.id %}
                                            {% if group_count and group_count > 1 %}
                                                <div class="image-counter">+{{ group_count|add:"-1" }}</div>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                </div>
                            </div>
                        {% elif resource.resource_type == 'video' and resource.file %}
                            <div class="resource-preview">
                                {% if file_url and file_url != '' %}
                                    {% with video_url=file_url %}
                                        <div class="custom-video-player" data-video-url="{{ video_url }}">
                                            <video preload="auto" class="video-element">
                                                <source src="{{ video_url }}" type="video/mp4">
                                                <source src="{{ video_url }}" type="video/webm">
                                                <source src="{{ video_url }}" type="video/ogg">
                                                Your browser does not support the video tag.
                                            </video>
                                            <div class="video-controls">
                                                <button class="play-pause-btn" aria-label="Play/Pause">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <div class="video-timeline">
                                                    <div class="timeline-track">
                                                        <div class="timeline-progress"></div>
                                                        <div class="timeline-thumb"></div>
                                                    </div>
                                                </div>
                                                <div class="video-time">
                                                    <span class="current-time">0:00</span>
                                                    <span class="time-separator">/</span>
                                                    <span class="total-time">0:00</span>
                                                </div>
                                                <div class="video-volume">
                                                    <button class="mute-btn" aria-label="Mute/Unmute">
                                                        <i class="fas fa-volume-up"></i>
                                                    </button>
                                                    <div class="volume-slider">
                                                        <div class="volume-track">
                                                            <div class="volume-progress"></div>
                                                            <div class="volume-thumb"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="fullscreen-btn" aria-label="Fullscreen">
                                                    <i class="fas fa-expand"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endwith %}
                                {% else %}
                                    {% with video_url=resource.file.url %}
                                        <div class="custom-video-player" data-video-url="{{ video_url }}">
                                            <video preload="auto" class="video-element">
                                                <source src="{{ video_url }}" type="video/mp4">
                                                <source src="{{ video_url }}" type="video/webm">
                                                <source src="{{ video_url }}" type="video/ogg">
                                                Your browser does not support the video tag.
                                            </video>
                                            <div class="video-controls">
                                                <button class="play-pause-btn" aria-label="Play/Pause">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                <div class="video-timeline">
                                                    <div class="timeline-track">
                                                        <div class="timeline-progress"></div>
                                                        <div class="timeline-thumb"></div>
                                                    </div>
                                                </div>
                                                <div class="video-time">
                                                    <span class="current-time">0:00</span>
                                                    <span class="time-separator">/</span>
                                                    <span class="total-time">0:00</span>
                                                </div>
                                                <div class="video-volume">
                                                    <button class="mute-btn" aria-label="Mute/Unmute">
                                                        <i class="fas fa-volume-up"></i>
                                                    </button>
                                                    <div class="volume-slider">
                                                        <div class="volume-track">
                                                            <div class="volume-progress"></div>
                                                            <div class="volume-thumb"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="fullscreen-btn" aria-label="Fullscreen">
                                                    <i class="fas fa-expand"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endwith %}
                                {% endif %}
                            </div>
                        {% elif resource.resource_type == 'link' and resource.external_url %}
                            <div class="url-preview" data-urls="{{ resource.external_url }}">
                                <div id="urls-container-{{ resource.id }}"></div>
                            </div>
                        {% elif resource.resource_type == 'document' and resource.file %}
                            <div class="resource-preview">
                                <div class="document-preview">
                                    <div class="document-preview-container">
                                        <div class="document-icon">
                                            {% if resource.file.name|lower|slice:"-4:" == ".pdf" %}üìÑ
                                            {% elif resource.file.name|lower|slice:"-5:" == ".xlsx" %}üìä
                                            {% elif resource.file.name|lower|slice:"-4:" == ".xls" %}üìä
                                            {% elif resource.file.name|lower|slice:"-4:" == ".csv" %}üìã
                                            {% elif resource.file.name|lower|slice:"-4:" == ".txt" %}üìù
                                            {% else %}üìÑ{% endif %}
                                        </div>
                                        <div class="document-info">
                                            <h4>Document File</h4>
                                            <p>
                                              {% if resource.file.name|lower|slice:"-4:" == ".pdf" %}PDF Document
                                              {% elif resource.file.name|lower|slice:"-5:" == ".xlsx" %}Excel Spreadsheet (.xlsx)
                                              {% elif resource.file.name|lower|slice:"-4:" == ".xls" %}Excel Spreadsheet (.xls)
                                              {% elif resource.file.name|lower|slice:"-4:" == ".csv" %}CSV File
                                              {% elif resource.file.name|lower|slice:"-4:" == ".txt" %}Text File
                                              {% else %}{{ resource.file.name|slice:"-4:"|upper }} file{% endif %}
                                            </p>
                                        </div>
                                        <div class="document-actions">
                                            <a href="{% url 'resources_panel:download_resource' resource.id %}" class="btn-view-document">Download</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="resource-footer">
                            <div class="meta-item">
                                <span class="meta-label">Uploaded at:</span>
                                <span class="meta-value">{{ resource.created_at|date:"F d, Y" }}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Uploaded by:</span>
                                <span class="meta-value">VigiLink Admin</span>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="resources-pagination" id="pagination-container">
                {% if page_obj.has_previous %}
                    <button type="button" class="page-btn" data-page="{{ page_obj.previous_page_number }}">Previous</button>
                {% endif %}
                
                <span class="page-btn active">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                
                {% if page_obj.has_next %}
                    <button type="button" class="page-btn" data-page="{{ page_obj.next_page_number }}">Next</button>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div class="no-resources">
                <div class="no-resources-icon">üìö</div>
                <h3>No Resources Found</h3>
                <p>
                    {% if search_query or filter_type != 'all' %}
                        No resources match your search criteria. Try adjusting your filters or search terms.
                    {% else %}
                        There are no resources available at the moment. Check back later for updates!
                    {% endif %}
                </p>
            </div>
        {% endif %}
        </div>
</div>

<!-- Image Modal -->
<div id="image-modal" class="image-modal">
    <div class="image-modal-content">
        <span class="image-modal-close">&times;</span>
        <button class="image-modal-prev" id="image-modal-prev" style="display: none;">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="image-modal-next" id="image-modal-next" style="display: none;">
            <i class="fas fa-chevron-right"></i>
        </button>
        <img id="modal-image" src="" alt="" class="modal-image">
        <div class="image-modal-counter" id="image-modal-counter" style="display: none;"></div>
    </div>
</div>

<script defer src="{% static 'resources/js/resources.js' %}"></script>
{% endblock %}


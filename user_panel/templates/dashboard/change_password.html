{% extends 'dashboard/base.html' %}

{% block title %}Change Password - VigiLink{% endblock %}

{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/view_profile.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<style>
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #4b5563;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
        transition: border-color 0.2s;
    }
    
    .form-control:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
    }
    
    /* Center buttons on mobile */
    @media (max-width: 768px) {
        .form-actions {
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        
        .btn-cancel, .btn-save {
            width: 100%;
            max-width: 200px;
            text-align: center;
        }
    }
    
    .btn-cancel {
        background: #f3f4f6;
        color: #4b5563;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-cancel:hover {
        background: #e5e7eb;
        color: #111827;
    }
    
    .btn-save {
        background: #4285f4;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-save:hover {
        background: #3b78e7;
    }
    
    .alert {
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1.5rem;
    }
    
    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }
    
    .alert-danger {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
    }
    
    .password-requirements {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #f9fafb;
        border-radius: 0.375rem;
        border: 1px solid #e5e7eb;
    }
    
    .password-requirements h4 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
        color: #4b5563;
    }
    
    .password-requirements ul {
        margin: 0;
        padding-left: 1.5rem;
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .requirement-icon {
        margin-right: 0.5rem;
    }
    
    .valid {
        color: #10b981;
    }
    
    .invalid {
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
    <div class="profile-edit-container">
        <h1 class="section-title">Change Password</h1>
        
        {% if messages %}
        <div id="message-container">
            {% for message in messages %}
            {% if 'Post created successfully!' != message|stringformat:"s" %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                {{ message }}
            </div>
            {% endif %}
            {% endfor %}
        </div>
        <script>
            // Auto-hide messages after 3.5 seconds
            setTimeout(function() {
                var messageContainer = document.getElementById('message-container');
                if (messageContainer) {
                    messageContainer.style.opacity = '0';
                    setTimeout(function() {
                        messageContainer.style.display = 'none';
                    }, 500);
                }
            }, 3500);
        </script>
        {% endif %}

        <form method="post" action="{% url 'user_panel:change_password' %}">
            {% csrf_token %}
            
            <div class="form-group">
                <label for="current_password" class="form-label">Current Password</label>
                <input type="password" id="current_password" name="current_password" class="form-control" required style="width: 100%;">
                {% if current_password_error %}
                <div class="error-message" style="color: #b91c1c; margin-top: 0.25rem; font-size: 0.875rem;">
                    {{ current_password_error }}
                </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="new_password" class="form-label">New Password</label>
                <div style="position: relative;">
                    <input type="password" id="new_password" name="new_password" class="form-control" required style="width: 100%;">
                    <span id="toggleNewPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none; line-height: 1;">
                        <i class="fa fa-eye-slash" aria-hidden="true"></i>
                    </span>
                </div>
                {% if new_password_error %}
                <div class="error-message" style="color: #b91c1c; margin-top: 0.25rem; font-size: 0.875rem;">
                    {{ new_password_error }}
                </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="confirm_password" class="form-label">Confirm New Password</label>
                <div style="position: relative;">
                    <input type="password" id="confirm_password" name="confirm_password" class="form-control" required style="width: 100%;">
                    <span id="toggleConfirmPassword" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; display: none; line-height: 1;">
                        <i class="fa fa-eye-slash" aria-hidden="true"></i>
                    </span>
                </div>
                {% if confirm_password_error %}
                <div class="error-message" style="color: #b91c1c; margin-top: 0.25rem; font-size: 0.875rem;">
                    {{ confirm_password_error }}
                </div>
                {% endif %}
            </div>
            
            <div class="password-requirements">
                <h4>Password Requirements:</h4>
                <ul>
                    <li id="length-req">
                        <span class="requirement-icon invalid">✗</span>
                        At least 8 characters long
                    </li>
                    <li id="uppercase-req">
                        <span class="requirement-icon invalid">✗</span>
                        Contains uppercase letter
                    </li>
                    <li id="lowercase-req">
                        <span class="requirement-icon invalid">✗</span>
                        Contains lowercase letter
                    </li>
                    <li id="number-req">
                        <span class="requirement-icon invalid">✗</span>
                        Contains number
                    </li>
                    <li id="special-req">
                        <span class="requirement-icon invalid">✗</span>
                        Contains special character
                    </li>
                    <li id="match-req">
                        <span class="requirement-icon invalid">✗</span>
                        Passwords match
                    </li>
                </ul>
            </div>
            
            <div class="form-actions">
                <a href="{% url 'user_panel:view_profile' %}" class="btn-cancel">Cancel</a>
                <button type="submit" class="btn-save" id="saveButton" disabled>Change Password</button>
            </div>
        </form>
    </div>
    
    <script>
        // Password validation
        const newPasswordInput = document.getElementById('new_password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const currentPasswordInput = document.getElementById('current_password');
        const saveButton = document.getElementById('saveButton');
        
        // Requirements elements
        const lengthReq = document.getElementById('length-req');
        const uppercaseReq = document.getElementById('uppercase-req');
        const lowercaseReq = document.getElementById('lowercase-req');
        const numberReq = document.getElementById('number-req');
        const specialReq = document.getElementById('special-req');
        const matchReq = document.getElementById('match-req');
        
        function validatePassword() {
            const password = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            const currentPassword = currentPasswordInput.value;
            
            // Check length
            const isLengthValid = password.length >= 8;
            updateRequirement(lengthReq, isLengthValid);
            
            // Check uppercase
            const hasUppercase = /[A-Z]/.test(password);
            updateRequirement(uppercaseReq, hasUppercase);
            
            // Check lowercase
            const hasLowercase = /[a-z]/.test(password);
            updateRequirement(lowercaseReq, hasLowercase);
            
            // Check number
            const hasNumber = /[0-9]/.test(password);
            updateRequirement(numberReq, hasNumber);
            
            // Check special character
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            updateRequirement(specialReq, hasSpecial);
            
            // Check if passwords match
            const doPasswordsMatch = password === confirmPassword && password !== '';
            updateRequirement(matchReq, doPasswordsMatch);
            
            // Enable/disable save button
            const isCurrentPasswordValid = currentPassword.length > 0;
            const isFormValid = isLengthValid && hasUppercase && hasLowercase && 
                               hasNumber && hasSpecial && doPasswordsMatch && isCurrentPasswordValid;
            
            saveButton.disabled = !isFormValid;
        }
        
        function updateRequirement(element, isValid) {
            const icon = element.querySelector('.requirement-icon');
            if (isValid) {
                icon.textContent = '✓';
                icon.classList.remove('invalid');
                icon.classList.add('valid');
            } else {
                icon.textContent = '✗';
                icon.classList.remove('valid');
                icon.classList.add('invalid');
            }
        }
        
        // Add event listeners
        newPasswordInput.addEventListener('input', validatePassword);
        confirmPasswordInput.addEventListener('input', validatePassword);
        currentPasswordInput.addEventListener('input', validatePassword);
        
        // Password visibility toggle
        const toggleNewPassword = document.getElementById('toggleNewPassword');
        const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
        
        // Show toggle icon only when user starts typing in new password field
        if (newPasswordInput) {
            newPasswordInput.addEventListener('input', function() {
                if (this.value.length > 0) {
                    toggleNewPassword.style.display = 'inline-block';
                } else {
                    toggleNewPassword.style.display = 'none';
                }
            });
        }
        
        // Show toggle icon only when user starts typing in confirm password field
        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', function() {
                if (this.value.length > 0) {
                    toggleConfirmPassword.style.display = 'inline-block';
                } else {
                    toggleConfirmPassword.style.display = 'none';
                }
            });
        }
        
        if (toggleNewPassword) {
            toggleNewPassword.addEventListener('click', function() {
                // Toggle the password field type
                const type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                newPasswordInput.setAttribute('type', type);
                
                // Toggle the eye icon
                const eyeIcon = toggleNewPassword.querySelector('i');
                eyeIcon.classList.toggle('fa-eye');
                eyeIcon.classList.toggle('fa-eye-slash');
            });
        }
        
        if (toggleConfirmPassword) {
            toggleConfirmPassword.addEventListener('click', function() {
                // Toggle the confirm password field type
                const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                confirmPasswordInput.setAttribute('type', type);
                
                // Toggle the eye icon
                const eyeIcon = toggleConfirmPassword.querySelector('i');
                eyeIcon.classList.toggle('fa-eye');
                eyeIcon.classList.toggle('fa-eye-slash');
            });
        }
    </script>
{% endblock %}
{% if no_results %}
<div class="no-results-message" style="text-align: center; padding: 20px; background-color: #f8f9fa; border-radius: 8px; margin: 20px 0;">
    <p style="font-size: 18px; color: #6c757d;">{{ no_results_message }}</p>
</div>
{% elif posts %}
    {% for post in posts %}
    <div class="post-card">
        <div class="post-header">
            <img src="{% if post.user.profile_picture_url %}{{ post.user.profile_picture_url }}?{% now 'U' %}{% elif post.user.profile_picture %}{{ post.user.profile_picture.url }}?{% now 'U' %}{% else %}/static/accounts/images/profile.png{% endif %}"
                 alt="{{ post.user.full_name }}" class="post-avatar" width="40" height="40" loading="lazy" decoding="async"
                 onerror="this.src='/static/accounts/images/profile.png'">
            <div class="post-info">
                <div class="post-header-info">
                    <div class="post-author">
                        <a href="{% url 'user_panel:view_user_profile' post.user.id %}" style="text-decoration: none; color: inherit;" class="author-link">{{ post.user.full_name }}</a>
                        {% if post.user.role == 'security' %}
                            <span class="role-badge role-badge-security">Security</span>
                        {% elif post.user.role == 'communityowner' %}
                            <span class="role-badge role-badge-president">Community President</span>
                        {% endif %}
                    </div>
                    <div class="post-date">{{ post.uploaded_at|date:"F j, Y, g:i a" }}</div>
                </div>
                {% if post.user == request.user %}
                <div class="post-actions-dropdown">
                    <button class="post-actions-toggle">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                        </svg>
                    </button>
                    <div class="post-actions-menu">
                        <button class="edit-post-btn" data-post-id="{{ post.post_id }}" data-post-message="{{ post.message }}">Edit</button>
                        <button class="delete-post-btn" data-post-id="{{ post.post_id }}">Delete</button>
                    </div>
                </div>
                {% endif %}
                <div class="post-content">{{ post.message }}</div>
                
                {% if post.get_images %}
                    <div class="post-images-gallery" data-post-id="{{ post.post_id }}">
                        {% with images=post.get_images %}
                            {% with image_count=post.image_count %}
                                {% for image in images|slice:":3" %}
                                    <div class="post-image-container {% if image_count == 1 %}single-image{% endif %}" data-index="{{ forloop.counter0 }}">
                                        {% if image.image_url %}
                                            <img src="{{ image.image_url }}" alt="Post image" class="post-image" loading="lazy" decoding="async">
                                        {% else %}
                                            <img src="{{ image.image.url }}" alt="Post image" class="post-image" loading="lazy" decoding="async">
                                        {% endif %}
                                    </div>
                                {% endfor %}
                                
                                {% if image_count > 3 %}
                                    <div class="post-image-container stacked" data-index="3">
                                        {% with fourth_image=images.3 %}
                                            {% if fourth_image.image_url %}
                                                <img src="{{ fourth_image.image_url }}" alt="Post image" class="post-image" loading="lazy" decoding="async">
                                            {% else %}
                                                <img src="{{ fourth_image.image.url }}" alt="Post image" class="post-image" loading="lazy" decoding="async">
                                            {% endif %}
                                            <div class="post-image-overlay">+{{ image_count|add:"-3" }}</div>
                                        {% endwith %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endwith %}
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="post-actions">
            <div class="action-buttons">
                <form method="post" action="{% url 'user_panel:react_to_post' post.post_id %}" class="reaction-form" style="display: inline;" onsubmit="return false;">
                    {% csrf_token %}
                    <button type="button" class="reaction-btn {% if post.user_reacted %}reacted{% endif %}">
                        <svg width="20" height="20" fill="{% if post.user_reacted %}#ef4444{% else %}none{% endif %}" stroke="{% if post.user_reacted %}#ef4444{% else %}currentColor{% endif %}" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                        </svg>
                        <span>{{ post.reaction_count }} {% if post.reaction_count == 1 %}Like{% else %}Likes{% endif %}</span>
                    </button>
                </form>
                
                <button class="reply-btn" data-post-id="{{ post.post_id }}">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span>View Comment</span>
                </button>
                
                <!-- Reply section (initially hidden) -->
                <div class="replies-section" id="replies-section-{{ post.post_id }}" style="display: none;">
                    <div class="replies-list" id="replies-list-{{ post.post_id }}">
                        <!-- Replies will be loaded here -->
                    </div>
                    <form class="reply-form" data-post-id="{{ post.post_id }}">
                        {% csrf_token %}
                        <textarea name="message" class="reply-input" placeholder="Write your comment..." required></textarea>
                        <div class="reply-form-actions">
                            <button type="submit" class="submit-reply-btn">Comment</button>
                        </div>
                        <div class="reply-error" style="display: none; color: red;"></div>
                    </form>
                </div>
                
                <!-- Share button removed as requested -->
            </div>
            <!-- Share count removed -->
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="no-posts">
        <p>No posts yet. Be the first to create a post!</p>
    </div>
{% endif %}
